<?php

/**
 * Implements hook_ctools_plugin_directory
 */
function oa_notifications_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools' && $plugin_type == 'content_types') {
    return 'plugins/content_types';
  }
}

/**
 * Implements hook_menu().
 */
function oa_notifications_menu() {
  // TODO: What are the proper access conditions here
  $items['js/oa_notifications/details/%node'] = array(
    'title' => 'Open Atrium Notification Details',
    'page callback' => 'oa_notifications_ajax_details',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function oa_notifications_theme() {
  return array(
    'oa_notifications_view' => array(
      'template' => 'oa-notifications-view',
      'variables' => array(
        'node' => NULL,
        'group' => array(),
        'team' => array(),
        'user' => array(),
      ),
      'path' => drupal_get_path('module', 'oa_notifications') . '/templates',
    ),
    'oa_notifications_details' => array(
      'template' => 'oa-notifications-details',
      'variables' => array(
        'users' => array(),
      ),
      'path' => drupal_get_path('module', 'oa_notifications') . '/templates',
    ),
  );
}


/**
 * Return the resolved list of all users to be notified on a piece of content.
 *
 * @param $node
 *    The node to return notifications
 * @return
 *    An array of users keyed by uid
 */
function oa_notifications_get_notifications($node) {
  $bucket = &drupal_static(__FUNCTION__);

  if (!isset($bucket)) {
    $bucket = array();
    $gid = $_SESSION[OG_SESSION_CONTEXT_ID];
    $notifications = oa_notifications_load_multiple($node);

    if (isset($notifications['group'])) {
      foreach (array_keys($notifications['group']) as $group_id) {
        $users = oa_core_get_group_users_for_space($gid, $group_id);
        $bucket += $users;
      }
    }

    if (isset($notifications['team'])) {
      foreach (array_keys($notifications['team']) as $team_id) {
        $results = oa_teams_get_team_members($team_id);
        $users = user_load_multiple(array_keys($results));
        $bucket += $users;
      }
    }

    if (isset($notifications['user'])) {
      $users = user_load_multiple(array_keys($notifications['user']));
      $bucket += $users;
    }
  }

  return $bucket;
}

/**
 * Some utility functions...
 */

/**
 * Get the listing of user with that are in the specified space, or the current
 * space if no space is specified that also have access to the provided node.
 *
 * @param int $gid
 *    The space ID
 */
function oa_notifications_get_users_for_node($node, $gid = NULL) {
  if (!isset($gid)) {
    // TODO: Consolidate this in a function
    $gid = $_SESSION[OG_SESSION_CONTEXT_ID];
  }
  $query = db_select('users', 'u');
  $query->rightJoin('og_membership', 'og', 'u.uid = og.etid');
  $query->fields('u', array('uid', 'name'))
      ->condition('og.entity_type', 'user')
      ->condition('og.gid', $gid);

  $results = $query->execute()->fetchAllAssoc('uid');

  // @TODO: This won't scale. We need users that have access to the given node
  // which is controlled by node_access grants, etc.  Not easily queried.
  // The move to an autocomplete might make this potential performance problem disappear.
  $users = user_load_multiple(array_keys($results));
  if (isset($node->nid)) {
    foreach ($users as $uid => $user) {
      if (!node_access('view', $node, $user)) {
        unset($users[$uid]);
      }
    }
  }
  return $users;
}

/**
 * Return all notifications for given source.  Optionally filtered by type.
 *
 * @param int $source_entity
 *    The loaded source entity
 * @param string $source_type
 *    The entity type of the source (defaults to 'node')
 * @params string $target_type
 *    An optional parameter that allows to filter the notification based on target type (group, team, user)
 * @return
 *    Returns an associative array of notifications first keyed by target type,
 *    then beneath that keyed by the target_id
 */
function oa_notifications_load_multiple($source_entity, $source_type = 'node', $target_type = NULL) {
  $source_id = array_shift(entity_extract_ids($source_type, $source_entity));
  $query = db_select('oa_notifications', 'n')
    ->fields('n')
    ->condition('n.source_id', $source_id)
    ->condition('n.$source_type', $source_type);

  if (isset($target_type)) {
    $query->condition('n.target_type', $target_type);
  }

  $notifications = array();
  $results = $query->execute()->fetchAllAssoc('notification_id');

  foreach ($results as $id => $row) {
    $notifications[$row->target_type][$row->target_id] = $row;
  }

  drupal_alter('oa_notifications_load', $notifications, $source_entity, $source_type, $target_type);

  return $notifications;
}

/**
 * @param $values
 */
function oa_notifications_save_notifications($values) {
  if (isset($values['source_entity']) && isset($values['source_type'])) {
    drupal_alter('oa_notifications_save', $values);
    $source_type = $values['source_type'];
    $source_id = array_shift(entity_extract_ids($source_type, $values['source_entity']));

    $notifications = array();
    foreach (array('group', 'team', 'user') as $type) {
      foreach ($values[$type] as $id) {
        $n = new stdClass;
        $n->source_id = $source_id;
        $n->source_type = $source_type;
        $n->target_id = $id;
        $n->target_type = $type;
        $notifications[] = $n;
      }
    }

    oa_notifications_save_for_source($source_id, $source_type, $notifications);
  }
}

/**
 * Save a collection of Notifications for a particular source item.
 *
 * @param int $source_id
 *    The ID of the source (typically a nid)
 * @param string $source_type
 *    The entity type of the source (defaults to 'node')
 * @param array $notifications
 *    A collection of Notification object for this source
 */
function oa_notifications_save_for_source($source_id, $source_type, $notifications) {
  db_delete('oa_notifications')
    ->condition('source_id', $source_id)
    ->condition('source_type', $source_type)
    ->execute();

  foreach ($notifications as $n) {
    drupal_write_record('oa_notifications', $n);
  }
}


/**
 * Implements hook_node_insert().
 */
function oa_notifications_node_insert($node) {
  if (oa_notifications_is_notification_type($node)) {
    $node->oa_notifications['source_entity'] = $node;
    oa_notifications_save_notifications($node->oa_notifications);
  }
}

/**
 * Implements hook_node_update().
 */
function oa_notifications_node_update($node) {
  if (oa_notifications_is_notification_type($node) && isset($node->oa_notifications)) {
    $node->oa_notifications['source_entity'] = $node;
    oa_notifications_save_notifications($node->oa_notifications);
  }
}

/**
 * Determine if this is an entity type on which we need to provide notifications
 *
 * @param $node
 * @return
 */
function oa_notifications_is_notification_type($node) {
  // @TODO: Implement this as configurable
  // for now, add notifications to any group-content type
  $types = oa_core_list_content_types(TRUE);
  return (array_key_exists($node->type, $types));
}

/**
 * Implements hook_node_delete().
 *
 * Cleanup the notifications for teams and groups as they are removed.
 *
 * @param $node
 *    The Node being deleted
 */
function oa_notifications_node_delete($node) {
  if ($node->type == OA_TEAM_TYPE) {
    $target_type = 'team';
  }
  else if ($node->type == OA_GROUP_TYPE) {
    $target_type = 'group';
  }

  if (isset($target_type)) {
    oa_notifications_delete_for_target($node->nid, $target_type);
  }
}

/**
 * Delete notifications for a target
 *
 * @param int $id
 *    The target id (e.g. node id)
 * @param string $type
 *    The target type (e.g. 'group', 'team')
 */
function oa_notifications_delete_for_target($id, $type) {
  db_delete('oa_notifications')
    ->condition('target_id', $id)
    ->condition('target_type', $type)
    ->execute();
}

/**
 * Callback for AJAX saving of the notification configuration when on a screen with a quick reply.
 *
 * @param $form
 * @param $form_state
 * @return mixed
 */
function oa_notifications_ajax_callback($form, $form_state) {
  oa_notifications_save_notifications($form_state['values']);

  $element = $form_state['triggering_element']['#name'];
  return $form[$element];
}

/**
 * Define the fields that are used for configuring notifications.
 *
 * @param $form
 * @param $form_state
 * @param $node
 */
function oa_notifications_form_fields(&$form, &$form_state, $node) {
  $nid = isset($node->nid) ? $node->nid : NULL;
  $form['source_type'] = array(
    '#type' => 'value',
    '#value' => 'node',
  );
  $form['source_entity'] = array(
    '#type' => 'value',
    '#value' => $node
  );

  $notifications = isset($nid) ? oa_notifications_load_multiple($node) : array();

  $all_groups = oa_core_get_all_groups();
  $form['group'] = array(
    '#type' => 'select',
    '#title' => t('Groups'),
    '#multiple' => TRUE,
    '#options' => array_map(create_function('$group', 'return $group->title;'), $all_groups),
    '#default_value' => isset($notifications['group']) ? array_keys($notifications['group']) : array(),
  );

  $space_teams = oa_teams_get_teams_for_space();
  $form['team'] = array(
    '#type' => 'select',
    '#title' => t('Teams'),
    '#multiple' => TRUE,
    '#options' => array_map(create_function('$team', 'return $team->title;'), $space_teams),
    '#default_value' => isset($notifications['team']) ? array_keys($notifications['team']) : array(),
  );

  $space_users = oa_notifications_get_users_for_node($node);
  $form['user'] = array(
    '#type' => 'select',
    '#title' => t('Users'),
    '#multiple' => TRUE,
    '#options' => array_map(create_function('$user', 'return $user->realname;'), $space_users),
    '#default_value' => isset($notifications['user']) ? array_keys($notifications['user']) : array(),
  );

}

/**
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function oa_notifications_form_node_form_alter(&$form, &$form_state, $form_id) {
  // we are on a node/edit/add form.
  // check content type
  if (isset($form['#node']) && (oa_notifications_is_notification_type($form['#node']))) {
    $form['oa_notifications'] = array(
      '#type' => 'fieldset',
      '#title' => t('Notifications'),
      '#collapsible' => TRUE,
      '#collapsed' => (in_array($form['#node']->type, array(OA_GROUP_TYPE, OA_SECTION_TYPE))) ? TRUE : FALSE,
      '#weight' => 9,
      '#tree' => TRUE,
    );
    oa_notifications_form_fields($form['oa_notifications'], $form_state, $form['#node']);
  }
}

/**
 * Return the listing of users to be notified for the provided Node.
 *
 * @param $node
 */
function oa_notifications_ajax_details($node) {
  $bucket = oa_notifications_get_notifications($node);

  $render = array();
  foreach ($bucket as $uid => $user) {
    if (node_access('view', $node, $user)) {
      $render[$uid] = array(
        'name' => $user->realname,
        'mail' => $user->mail,
      );
    }
  }

  echo theme('oa_notifications_details', array('users' => $render));
}
