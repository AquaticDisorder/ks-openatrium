<?php

/**
 * @file
 * Tests permission inheritence for oa_subspaces
 */

class oa_subspacesSectionAccess extends oa_sectionsAccess {
  static function getInfo() {
    return array(
      'name' => 'OA Subspace Section Permission test',
      'description' => 'Test that can access sections correctly',
      'group' => 'OA - Subspaces',
    );
  }

  function test_oa_subspacesSectionAccess() {
    // Set up basic users and basic parent/child public spaces.
    extract($this->createOaSpaceAndUsers(array('og_user_inheritance' => array(LANGUAGE_NONE => array(0 => array('value' => 1))))));
    $space_member_2 = $this->createUserInOaSpace($space);
    $child = $this->createOaSpace(array('oa_parent_space' => array(LANGUAGE_NONE => array(0 => array('target_id' => $space->nid)))));

    // Set up public group and two level deep group hierarchy.
    $group = $this->drupalCreateNode(array('uid' => $space_admin, 'type' => 'oa_group'));
    og_group('node', $group, array('entity' => $space_member));
    og_group('node', $group, array('entity' => $space_member_2));
    $space_child_of_group = $this->createOaSpace(array('uid' => $space_admin, 'oa_parent_space' => array(LANGUAGE_NONE => array(0 => array('target_id' => $group->nid)))));
    $space_child_of_space_of_group = $this->createOaSpace(array('uid' => $space_admin, 'oa_parent_space' => array(LANGUAGE_NONE => array(0 => array('target_id' => $space_child_of_group->nid)))));


    $group_member_only = $this->drupalCreateNode(array('type' => 'oa_group'));
    og_group('node', $group, array('entity' => $group_member_only));

    // Set of private group and two level deep group hierarchy.
    $group_private = $this->drupalCreateNode(array('uid' => $space_admin, 'type' => 'oa_group', 'group_access' => array(LANGUAGE_NONE => array(array('value' => 1)))));
    og_group('node', $group_private, array('entity' => $space_member));
    og_group('node', $group_private, array('entity' => $space_member_2));
    $space_child_of_group_private = $this->createOaSpace(array('uid' => $space_admin, 'oa_parent_space' => array(LANGUAGE_NONE => array(0 => array('target_id' => $group_private->nid))), 'group_access' => array(LANGUAGE_NONE => array(array('value' => 1)))));
    $space_child_of_space_of_group_private = $this->createOaSpace(array('uid' => $space_admin, 'oa_parent_space' => array(LANGUAGE_NONE => array(0 => array('target_id' => $space_child_of_group_private->nid))), 'group_access' => array(LANGUAGE_NONE => array(array('value' => 1)))));

    $this->oaTestOaSectionAccess($space, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
    $this->oaTestOaSectionAccess($child, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
    $this->oaTestOaSectionAccess($space_child_of_group, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
    $this->oaTestOaSectionAccess($space_child_of_space_of_group, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
    $this->oaTestOaSectionAccess($space_child_of_group_private, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
    $this->oaTestOaSectionAccess($space_child_of_space_of_group_private, $test_space, $space_admin, $space_member, $space_member_2, $group_member_only);
  }

}
